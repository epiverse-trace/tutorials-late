---
title: 'Comparing public health outcomes of interventions'
teaching: 45 # teaching time in minutes
exercises: 30 # exercise time in minutes

---

```{r setup, echo= FALSE, message = FALSE, warning = FALSE}
webshot::install_phantomjs(force = TRUE)
library(epidemics)

polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  polymod,
  countries = "United Kingdom",
  age.limits = c(0, 15, 65),
  symmetric = TRUE
)

# prepare contact matrix
contact_matrix <- t(contact_data$matrix)

# prepare the demography vector
demography_vector <- contact_data$demography$population
names(demography_vector) <- rownames(contact_matrix)

# initial conditions: one in every 1 million is infected
initial_i <- 1e-6
initial_conditions <- c(
  S = 1 - initial_i, E = 0, I = initial_i, R = 0, V = 0
)

# build for all age groups
initial_conditions <- matrix(
  rep(initial_conditions, dim(contact_matrix)[1]),
  ncol = 5, byrow = TRUE
)
rownames(initial_conditions) <- rownames(contact_matrix)

# prepare the population to model as affected by the epidemic
uk_population <- epidemics::population(
  name = "UK",
  contact_matrix = contact_matrix,
  demography_vector = demography_vector,
  initial_conditions = initial_conditions
)

close_schools <- intervention(
  name = "School closure",
  type = "contacts",
  time_begin = 50,
  time_end = 50 + 100,
  reduction = matrix(c(0.5, 0.01, 0.01))
)

mask_mandate <- intervention(
  name = "mask mandate",
  type = "rate",
  time_begin = 40,
  time_end = 40 + 200,
  reduction = 0.163
)

# time periods
preinfectious_period <- 4.0
infectious_period <- 5.5
basic_reproduction <- 2.7

# rates
infectiousness_rate <- 1.0 / preinfectious_period
recovery_rate <- 1.0 / infectious_period
transmission_rate <- basic_reproduction / infectious_period

output_baseline <- model_default(
  population = uk_population,
  transmission_rate = transmission_rate,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  time_end = 300, increment = 1.0
)

```


:::::::::::::::::::::::::::::::::::::: questions 

- How can I quantify the effect of an intervention?

 
::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Compare intervention scenarios

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: prereq

## Prerequisites
+ Complete tutorials [Simulating transmission](../episodes/simulating-transmission.md) and [Modelling interventions](../episodes/modelling-interventions.md)

Learners should familiarise themselves with following concept dependencies before working through this tutorial: 

**Outbreak response** : [Intervention types](https://www.cdc.gov/nonpharmaceutical-interventions/).
:::::::::::::::::::::::::::::::::


## Introduction

In this tutorial we will compare intervention scenarios against each other. To quantify the effect of the intervention we need to compare our intervention scenario to a counter factual (baseline) scenario. The *counter factual* is the scenario in which nothing changes, often referred to as the 'do nothing' scenario. The counter factual scenario may include no interventions, or if we are investigating the potential impact of an additional intervention in the later stages of an outbreak there may be existing interventions in place. 

We must also decide what our *outcome of interest* is to make comparisons between intervention and counter factual scenarios. The outcome of interest can be:

+ a model outcome, e.g. number of infections or hospitalisations,
+ a metric such as the epidemic peak time or size,
+ a measure that uses the model outcomes such as QALY/DALYs.

In this tutorial we are going to learn how to use the `{epidemics}` package to compare the effect of different interventions on simulated disease trajectories. We will access to social contact data with `{socialmixr}`.

```{r,message=FALSE,warning=FALSE}
library(epidemics)
library(socialmixr)
library(tidyverse)
```


:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: instructor

In this tutorial we introduce the concept of the counter factual and how to compare scenarios (counter factual versus intervention) against each other. 

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

## Visualising the effect of interventions 

To compare the baseline scenario against the intervention scenarios, we can make visualisations of the model output or some aggregate measure of the model output. If we wanted to investigate the change in epidemic peak with an intervention applied we could plot the model trajectories through time:
```{r}
output_baseline <- model_default(
  population = uk_population,
  transmission_rate = transmission_rate,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  time_end = 300, increment = 1.0
)

output_school <- model_default(
  # population
  population = uk_population,
  # rate
  transmission_rate = transmission_rate,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  # intervention
  intervention = list(contacts = close_schools),
  # time
  time_end = 300, increment = 1.0
)

# create intervention_type column for plotting
output_school$intervention_type <- "school closure"
output_baseline$intervention_type <- "baseline"
output <- rbind(output_school, output_baseline)

output %>%
  filter(compartment == "infectious") %>%
  ggplot() +
  aes(
    x = time,
    y = value,
    color = intervention_type,
    linetype = intervention_type
  ) +
  stat_summary(
    fun = "sum",
    geom = "line",
    linewidth = 1
  ) +
  scale_y_continuous(
    labels = scales::comma
  ) +
  geom_vline(
    xintercept = c(
      close_schools$time_begin,
      close_schools$time_end
    ),
    linetype = 2
  ) +
  theme_bw() +
  labs(
    x = "Simulation time (days)",
    y = "Individuals"
  )
```
To quantify the impact of the intervention over the model output through time time, we could consider the cumulative number in the different scenarios. For example, the cumulative number of infectious people in the baseline scenario compared to the intervention scenario: 

```{r}
output %>%
  filter(compartment == "infectious") %>% 
  group_by(time, intervention_type) %>%     
  summarise(value_total = sum(value)) %>%   
  group_by(intervention_type) %>%
  mutate(cum_value = cumsum(value_total)) %>%
  ggplot() +
  geom_line(
  aes(
    x = time,
    y = cum_value,
    color = intervention_type,
    linetype = intervention_type
  ),
  linewidth = 1.2
  )+
  scale_y_continuous(
    labels = scales::comma
  ) +
  geom_vline(
    xintercept = c(
      close_schools$time_begin,
      close_schools$time_end
    ),
    linetype = 2
  ) +
  theme_bw() +
  labs(
    x = "Simulation time (days)",
    y = "Cumulative number of infectious individuals"
  )
```

## Accounting for uncertainty

We will extend the COVID-19 example in [Modelling interventions](../episodes/modelling-interventions.md) to account for some uncertainty in the parameter values, specifically in the basic reproduction $R_0$. We do this as follows: 

```{r}
# time periods
preinfectious_period <- 4.0
infectious_period <- 5.5

# specify the mean and standard deviation of R0 
r_estimate_mean <- 2.7
r_estimate_sd <- 0.05

# Generate 100 R samples
r_samples <- withr::with_seed(
  seed = 1,
  rnorm(
    n = 100, mean = r_estimate_mean, sd = r_estimate_sd
  )
)

beta <- r_samples / infectious_period

# rates
infectiousness_rate <- 1.0 / preinfectious_period
recovery_rate <- 1.0 / infectious_period
```

We use these parameter values alongside the population structure and contact matrix used in [Modelling interventions](../episodes/modelling-interventions.md) to run the model for the baseline scenario:

```{r}
output_baseline <- model_default(
  population = uk_population,
  transmission_rate = beta,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  time_end = 300, increment = 1.0
)
```


Then, we create a list of all the interventions we want to include in our comparison. We define our scenarios as follows:

+ scenario 1 : close schools
+ scenario 2 : mask mandate
+ scenario 3 : close schools and mask mandate.

In R we specify this as: 
```{r}
intervention_scenarios <- list(
  scenario_1 = list(
    contacts = close_schools
  ),
  scenario_2 = list(
    transmission_rate = mask_mandate
  ),
  scenario_3 = list(
    contacts = close_schools,
    transmission_rate = mask_mandate
  )
)
```

We use this list as our input to `intervention` in `model_default`

```{r}
output <- model_default(
  uk_population,
  transmission_rate = beta,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  time_end = 300, increment = 1.0,
  intervention = intervention_scenarios
  )
head(output)
```

Now that we have our model output for all of our scenarios, we want to compare the outputs of the interventions to our baseline. 

We can do this using `outcomes_averted()` in  `{epidemics}`. This function calculates the final epidemic size for each scenario, and then calculates the number of infections averted in each scenario compared to the baseline. To use this function we specify the :
  
+ output of the baseline scenario
+ outputs of the intervention scenario(s).

```{r}
intervention_effect <- outcomes_averted(
  baseline = output_baseline, scenarios = output
)
intervention_effect
```

The output gives us the infections averted in each scenario compared to the baseline. To obtain the infections averted overall we specify `by_group = FALSE`:

```{r}
intervention_effect <- outcomes_averted(
  baseline = output_baseline, scenarios = output,
  by_group = FALSE
)
intervention_effect
```


## Vacamole model

The Vacamole model is a deterministic model based on a system of ODEs in [Ainslie et al. 2022](https://doi.org/10.2807/1560-7917.ES.2022.27.44.2101090) to describe the effect of vaccination on COVID-19 dynamics. The model consists of 11 compartments, individuals are classed as one of the following:

+ susceptible, $S$,
+ partial vaccination ($V_1$), fully vaccination ($V_2$),
+ exposed, $E$ and exposed while vaccinated, $E_V$,
+ infectious, $I$ and infectious while vaccinated, $I_V$,
+ hospitalised, $H$ and hospitalised while vaccinated, $H_V$,
+ dead, $D$,
+ recovered, $R$.

The diagram below describes the flow of individuals through the different compartments. 

```{r, echo = FALSE, message = FALSE}
DiagrammeR::grViz("digraph{
  # graph statement
  #################
  graph [layout = dot,
         rankdir = LR,
         overlap = true,
         fontsize = 10]

  # nodes
  #######
  node [shape = square,
       fixedsize = true
       width = 1.3]

       S
       E
       Ev [label = 'E@_{V}', style = filled, fillcolour = 'gray']
       I
       Iv [label = 'I@_{V}', style = filled, fillcolour = 'gray']
       H
       Hv [label = 'H@_{V}', style = filled, fillcolour = 'gray']
       D
       R
       V1 [label = 'V@_{1}', style = filled, fillcolour = 'gray']
       V2 [label = 'V@_{2}', style = filled, fillcolour = 'gray']


  # edges
  #######
  S -> E [label = ' infection (&beta;) ']
  S -> V1 [label = ' vaccination (&nu;1)']
  V1 -> E [label = ' infection (&beta;)']
  V1 -> V2 [label = ' vaccination\n(second dose) (&nu;2)']
  V2 -> Ev [label = ' infection (&beta;)']
  Ev -> Iv [label = ' onset of \ninfectiousness (&alpha;) ']
  E -> I [label = ' onset of \ninfectiousness (&alpha;) ']
  I -> H [label = ' hospitalisation (&eta;)']
  Iv -> Hv [label = ' hospitalisation (&eta;@_{V})']
  I -> D [label = ' death (&omega;)']
  I -> R [label = ' recovery (&gamma;)']
  Iv -> D [label = ' death (&omega;@_{V})']
  Iv -> R [label = ' recovery (&gamma;)']
  Hv -> D [label = ' death (&omega;@_{V})']
  Hv -> R [label = ' recovery (&gamma;)']
  H -> D [label = ' death (&omega;)']
  H -> R [label = ' recovery (&gamma;)']

  subgraph {
  rank = same; S; V1;V2;
  }
}")
```


::::::::::::::::::::::::::::::::::::: challenge

## Running a counterfactual scenario using the Vacamole model 

1. Run the model with the default parameter values for the UK population assuming that :

+ 1 in a million individual are infectious (and not vaccinated) at the start of the simulation
+ The contact matrix for the United Kingdom has age bins:
  + age between 0 and 20 years,
  + age between 20 and 40,
  + 40 years and over.
+ There is no vaccination scheme in place

2. Using the output, plot the cumulative number of deaths through time


<!-- ::::::::::::::::: hint -->

<!-- ### Vaccination code  -->

<!-- To run the model with no vaccination in place we can *either* create two vaccination objects (one for each dose) using `vaccination()` with the time start, time end and vaccination rate all set to 0. -->

<!-- ```{r} -->
<!-- library(epidemics) -->
<!-- ``` -->

<!-- ```{r, eval = FALSE} -->
<!-- ?vaccination -->
<!-- ``` -->

<!-- :::::::::::::::::::::: -->


::::::::::::::::: hint

### HINT : Running the model with default parameter values

We can run the Vacamole model with [default parameter values](https://epiverse-trace.github.io/epidemics/articles/model_vacamole.html#model-epidemic-using-vacamole) by just specifying the population object and number of time steps to run the model for: 


```{r, eval = FALSE}
output <- model_vacamole(
  population = uk_population,
  time_end = 300
)
```

::::::::::::::::::::::



::::::::::::::::: solution

### SOLUTION

1.  Run the model

```{r}
library(epidemics)
```

```{r}
polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  survey = polymod,
  countries = "United Kingdom",
  age.limits = c(0, 20, 40),
  symmetric = TRUE
)
# prepare contact matrix
contact_matrix <- t(contact_data$matrix)

# extract demography vector
demography_vector <- contact_data$demography$population
names(demography_vector) <- rownames(contact_matrix)

# prepare initial conditions
initial_i <- 1e-6

initial_conditions <- c(
  S = 1 - initial_i,
  V1 = 0, V2 = 0,
  E = 0, EV = 0,
  I = initial_i, IV = 0,
  H = 0, HV = 0, D = 0, R = 0
)

initial_conditions <- rbind(
  initial_conditions,
  initial_conditions,
  initial_conditions
)
rownames(initial_conditions) <- rownames(contact_matrix)

# prepare population object
uk_population <- population(
  name = "UK",
  contact_matrix = contact_matrix,
  demography_vector = demography_vector,
  initial_conditions = initial_conditions
)

# run model
output <- model_vacamole(
  population = uk_population,
  time_end = 300
)
```

2. Plot the number of deaths through time

```{r}
library(ggplot2)

ggplot(output[output$compartment == "dead", ]) +
  geom_line(
    aes(time, value, colour = demography_group),
    linewidth = 1
  ) +
  scale_colour_brewer(
    palette = "Dark2",
    labels = rownames(contact_matrix),
    name = "Age group"
  ) +
  scale_y_continuous(
    labels = scales::comma
  ) +
  labs(
    x = "Simulation time (days)",
    y = "Individuals"
  ) +
  theme(
    legend.position = "top"
  ) +
  theme_bw(
    base_size = 15
  )
```



:::::::::::::::::::::::::::


::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::: testimonial

### Package vignettes

We recommend to read the vignette on [Modelling responses to a stochastic Ebola virus epidemic](https://epiverse-trace.github.io/epidemics/articles/model_ebola.html) to use a discrete time, stochastic compartmental model of Ebola used during the 2014 West African EVD outbreak.

:::::::::::::::::::::::::::

<!-- ## Comparing scenarios -->

<!-- *Coming soon* -->



<!-- ## Challenge : Ebola outbreak analysis  -->

<!-- *Coming soon* -->




::::::::::::::::::::::::::::::::::::: keypoints 

- The counter factual scenario must be defined to make comparisons

::::::::::::::::::::::::::::::::::::::::::::::::
