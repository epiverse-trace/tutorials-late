---
title: 'Vaccine comparisons'
teaching: 10
exercises: 2
---

:::::::::::::::::::::::::::::::::::::: questions 

- What questions will this lesson cover?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Objective 1
- Objective 2

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: prereq

+ Complete tutorials [Simulating transmission](../episodes/simulating-transmission.md), [Modelling interventions](../episodes/modelling-interventions.md) and [Comparing public health outcomes of interventions](../episodes/compare-interventions.md). 

Learners should familiarise themselves with following concept dependencies before working through this tutorial: 

**Outbreak response** : [Intervention types](https://www.cdc.gov/nonpharmaceutical-interventions/).
:::::::::::::::::::::::::::::::::


## Introduction

Introductory text

```{r, message = FALSE}
library(ggplot2)
library(epidemics)
library(dplyr)
```


:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: instructor

Inline instructor notes can help inform instructors of timing challenges
associated with the lessons. They appear in the "Instructor View".

READ THESE LINES AND ERASE:

The Workbench-related sections that the developer must keep are:

- YAML on top
- Questions
- Objectives
- Keypoints

The Epiverse-TRACE sections that we encourage to keep are:

- Prerequisites
- Introduction

Take a look to the Contributing.md file for more writing guidelines.

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


## Direct and indirect effects of vaccination

Vaccination programs using infection-blocking vaccines have two benefits:

1. Reducing individual risk of infection (**direct** effect of vaccination)
2. Reducing onward contribution to transmission (**indirect** effect of vaccination).


We will illustrate this using results from `model_default()` in `{epidemics}`. Using the contact matrix and parameters from the COVID-19 outbreak example in [Modelling interventions](../episodes/modelling-interventions.md) we will investigate the impact of two vaccination programs on the number of infections. We will assume that vaccination programs start on day 0 and continue to be in place for 150 days. We will assume all age groups are vaccinated at the same rate in each program as follows :

+ vaccination program 01 : vaccination rate 0.001
+ vaccination program 02 : vaccination rate 0.01.


```{r, echo = FALSE, message = FALSE}
polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  polymod,
  countries = "United Kingdom",
  age.limits = c(0, 15, 65),
  symmetric = TRUE
)


# prepare contact matrix
contact_matrix <- t(contact_data$matrix)

# prepare the demography vector
demography_vector <- contact_data$demography$population
names(demography_vector) <- rownames(contact_matrix)

# initial conditions: one in every 1 million is infected
initial_i <- 1e-6
initial_conditions <- c(
  S = 1 - initial_i, E = 0, I = initial_i, R = 0, V = 0
)

# build for all age groups
initial_conditions <- matrix(
  rep(initial_conditions, dim(contact_matrix)[1]),
  ncol = 5, byrow = TRUE
)
rownames(initial_conditions) <- rownames(contact_matrix)

# prepare the population to model as affected by the epidemic
uk_population <- epidemics::population(
  name = "UK",
  contact_matrix = contact_matrix,
  demography_vector = demography_vector,
  initial_conditions = initial_conditions
)

# time periods
preinfectious_period <- 4.0
infectious_period <- 5.5
basic_reproduction <- 2.7

# rates
infectiousness_rate <- 1.0 / preinfectious_period
recovery_rate <- 1.0 / infectious_period
transmission_rate <- basic_reproduction / infectious_period
```


```{r}
# prepare vaccination objects
vaccinate_01 <- vaccination(
  name = "vaccinate all",
  time_begin = matrix(0, nrow(contact_matrix)),
  time_end = matrix(150, nrow(contact_matrix)),
  nu = matrix(c(0.001, 0.001, 0.001))
)

vaccinate_02 <- vaccination(
  name = "vaccinate all",
  time_begin = matrix(0, nrow(contact_matrix)),
  time_end = matrix(150, nrow(contact_matrix)),
  nu = matrix(c(0.01, 0.01, 0.01))
)
```


We see the intuitive result that the higher the vaccination rate, the more people that are vaccinated. 


::: tab

### Output

```{r, echo = FALSE, eval = TRUE}
output_baseline <- model_default(
  # population
  population = uk_population,
  # rate
  transmission_rate = transmission_rate,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  # time
  time_end = 200, increment = 1.0
)

output_vaccinate_01 <- model_default(
  # population
  population = uk_population,
  # rate
  transmission_rate = transmission_rate,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  # intervention
  vaccination = vaccinate_01,
  # time
  time_end = 200, increment = 1.0
)

output_vaccinate_02 <- model_default(
  # population
  population = uk_population,
  # rate
  transmission_rate = transmission_rate,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  # intervention
  vaccination = vaccinate_02,
  # time
  time_end = 200, increment = 1.0
)

# create intervention_type column for plotting
output_baseline$intervention_type  <- "baseline"
output_vaccinate_01$intervention_type  <- "vaccinate 0.001"
output_vaccinate_02$intervention_type  <- "vaccinate 0.01"
output <- rbind(output_baseline, output_vaccinate_01, output_vaccinate_02)


output %>%
  filter(compartment == "vaccinated") %>%
  ggplot() +
  ggtitle("Number vaccinated") +
  aes(
    x = time,
    y = value,
    color = intervention_type,
    linetype = intervention_type
  ) +
  stat_summary(
    fun = "sum",
    geom = "line",
    linewidth = 1
  ) +
  scale_y_continuous(
    labels = scales::comma
  ) +
  geom_vline(
    xintercept = c(
      vaccinate_01$time_begin,
      vaccinate_01$time_end
    ),
    linetype = 2
  ) +
  theme_bw() +
  labs(
    x = "Simulation time (days)",
    y = "Individuals"
  )
```

### R Code

```{r, echo = TRUE, eval = FALSE}
output_baseline <- model_default(
  # population
  population = uk_population,
  # rate
  transmission_rate = transmission_rate,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  # time
  time_end = 200, increment = 1.0
)

output_vaccinate_01 <- model_default(
  # population
  population = uk_population,
  # rate
  transmission_rate = transmission_rate,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  # intervention
  vaccination = vaccinate_01,
  # time
  time_end = 200, increment = 1.0
)

output_vaccinate_02 <- model_default(
  # population
  population = uk_population,
  # rate
  transmission_rate = transmission_rate,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  # intervention
  vaccination = vaccinate_02,
  # time
  time_end = 200, increment = 1.0
)

# create intervention_type column for plotting
output_baseline$intervention_type <- "baseline"
output_vaccinate_01$intervention_type<- "vaccinate 0.001"
output_vaccinate_02$intervention_type <- "vaccinate 0.01"
output <- rbind(output_baseline, output_vaccinate_01, output_vaccinate_02)


output %>%
  filter(compartment == "vaccinated") %>%
  ggplot() +
  ggtitle("Number vaccinated") +
  aes(
    x = time,
    y = value,
    color = intervention_type,
    linetype = intervention_type
  ) +
  stat_summary(
    fun = "sum",
    geom = "line",
    linewidth = 1
  ) +
  scale_y_continuous(
    labels = scales::comma
  ) +
  geom_vline(
    xintercept = c(
      vaccinate_01$time_begin,
      vaccinate_01$time_end
    ),
    linetype = 2
  ) +
  theme_bw() +
  labs(
    x = "Simulation time (days)",
    y = "Individuals"
  )
```


:::

To show the **indirect** effect of vaccinations, we want to see the effect that vaccination has on the number of new infections. We will use the function `new_infections()` in `{epidemics}` to calculate the number of new infections over time for the different vaccination programs. 

The inputs required are :

+ `data` : the model output,
+ `compartments_from_susceptible` : this is an optional input, but in our case needed. We don't want the number of people vaccinated to be counted as new infections, so we need to specify the name of the model compartment where individuals transition out from `susceptible` (in this example `vaccinated`),
+ `by_group` : should the results be calculated for each demographic group separately. 


```{r}
vaccinate_01_infections <- new_infections(output_vaccinate_01,
                                          compartments_from_susceptible =
                                            "vaccinated",
                                          by_group = FALSE)

```


::: tab

### Output 

```{r, echo = FALSE, eval = TRUE}
# calculate new infections
baseline_infections <- new_infections(output_baseline,
                                      compartments_from_susceptible =
                                        "vaccinated",
                                      by_group = FALSE)
vaccinate_01_infections <- new_infections(output_vaccinate_01,
                                          compartments_from_susceptible =
                                            "vaccinated",
                                          by_group = FALSE)
vaccinate_02_infections <- new_infections(output_vaccinate_02,
                                          compartments_from_susceptible =
                                            "vaccinated",
                                          by_group = FALSE)

# create intervention_type column for plotting
baseline_infections$intervention_type <- "baseline"
vaccinate_01_infections$intervention_type <- "vaccinate 0.001"
vaccinate_02_infections$intervention_type<- "vaccinate 0.01"
infections <- rbind(baseline_infections,
                    vaccinate_01_infections,
                    vaccinate_02_infections)


infections %>%
  ggplot() +
  ggtitle("New infections") +
  geom_line(
            aes(time, new_infections, colour = intervention_type,
              linetype = intervention_type
            ),
            linewidth = 1) +
  scale_y_continuous(
    labels = scales::comma
  ) +
  geom_vline(
    xintercept = c(
      vaccinate_01$time_begin,
      vaccinate_01$time_end
    ),
    linetype = 2
  ) +
  theme_bw() +
  labs(
    x = "Simulation time (days)",
    y = "Individuals"
  )
```

### R code

```{r, echo = TRUE, eval = FALSE}
# calculate new infections
baseline_infections <- new_infections(output_baseline,
                                      compartments_from_susceptible =
                                        "vaccinated",
                                      by_group = FALSE)
vaccinate_01_infections <- new_infections(output_vaccinate_01,
                                          compartments_from_susceptible =
                                            "vaccinated",
                                          by_group = FALSE)
vaccinate_02_infections <- new_infections(output_vaccinate_02,
                                          compartments_from_susceptible =
                                            "vaccinated",
                                          by_group = FALSE)

# create intervention_type column for plotting
baseline_infections$intervention_type <- "baseline"
vaccinate_01_infections$intervention_type  <- "vaccinate 0.001"
vaccinate_02_infections$intervention_type  <- "vaccinate 0.01"
infections <- rbind(baseline_infections,
                    vaccinate_01_infections,
                    vaccinate_02_infections)


infections %>%
  ggplot() +
  ggtitle("New infections") +
  geom_line(
            aes(time, new_infections, colour = intervention_type,
              linetype = intervention_type
            ),
            linewidth = 1) +
  scale_y_continuous(
    labels = scales::comma
  ) +
  geom_vline(
    xintercept = c(
      vaccinate_01$time_begin,
      vaccinate_01$time_end
    ),
    linetype = 2
  ) +
  theme_bw() +
  labs(
    x = "Simulation time (days)",
    y = "Individuals"
  )
```

:::


We see that even after accounting for the number of people vaccinated, there are fewer new infections when you have a higher vaccination rate. This is because there are fewer people susceptible to infection, and therefore fewer people who can become infected and contribute to onward infection. 

This **indirect** effect of vaccination programs is key to successfully controlling and eradicating infections. Vaccinated people 

::::::::::::::::::::::::::::::::::::: callout
## Herd immunity threshold

For homogeneous mixing populations, there exists a target threshold of vaccination based on the basic reproduction number $R_0$. 




::::::::::::::::::::::::::::::::::::::::::::::::


::::::::::::::::::::::::::::::::::::: challenge 

## Vaccination thresholds

what is the vaccination rate required to prevent an epidemic

:::::::::::::::::::::::: solution 

## Output
 
```{r polymod_uk, echo = FALSE}
polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  polymod,
  countries = "United Kingdom",
  age.limits = c(0, 20, 40),
  symmetric = TRUE
)
contact_data
```


:::::::::::::::::::::::::::::::::
::::::::::::::::::::::::::::::::::::::::::::::::


## Targeted vaccination

Effect of vaccinating high risk groups

```{r, collapse=TRUE}
vaccinate_group_1 <- vaccination(
  name = "vaccinate all",
  time_begin = matrix(40, nrow(contact_matrix)),
  time_end = matrix(40 + 150, nrow(contact_matrix)),
  nu = matrix(c(0.001 * 3, 0, 0))
)

vaccinate_group_2 <- vaccination(
  name = "vaccinate all",
  time_begin = matrix(40, nrow(contact_matrix)),
  time_end = matrix(40 + 150, nrow(contact_matrix)),
  nu = matrix(c(0, 0.001 * 3, 0))
)

vaccinate_group_3 <- vaccination(
  name = "vaccinate all",
  time_begin = matrix(40, nrow(contact_matrix)),
  time_end = matrix(40 + 150, nrow(contact_matrix)),
  nu = matrix(c(0, 0, 0.001 * 3))
)

output_vaccinate_group_1 <- model_default(
  # population
  population = uk_population,
  # rate
  transmission_rate = transmission_rate,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  # intervention
  vaccination = vaccinate_group_1,
  # time
  time_end = 300, increment = 1.0
)

output_vaccinate_group_2 <- model_default(
  # population
  population = uk_population,
  # rate
  transmission_rate = transmission_rate,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  # intervention
  vaccination = vaccinate_group_2,
  # time
  time_end = 300, increment = 1.0
)


output_vaccinate_group_3 <- model_default(
  # population
  population = uk_population,
  # rate
  transmission_rate = transmission_rate,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  # intervention
  vaccination = vaccinate_group_3,
  # time
  time_end = 300, increment = 1.0
)

vaccinate_group_1_infections <- new_infections(output_vaccinate_group_1,
                                               compartments_from_susceptible =
                                                 "vaccinated", by_group = FALSE)
vaccinate_group_2_infections <- new_infections(output_vaccinate_group_2,
                                               compartments_from_susceptible =
                                                 "vaccinated", by_group = FALSE)
vaccinate_group_3_infections <- new_infections(output_vaccinate_group_3,
                                               compartments_from_susceptible =
                                                 "vaccinated", by_group = FALSE)

vaccinate_group_1_infections$intervention_type  <- "vaccinate group 1"
vaccinate_group_2_infections$intervention_type  <- "vaccinate group 2"
vaccinate_group_3_infections$intervention_type  <- "vaccinate group 3"

output_infections <- rbind(baseline_infections,
                           vaccinate_01_infections,
                           vaccinate_group_1_infections,
                           vaccinate_group_2_infections,
                           vaccinate_group_3_infections)


output_infections %>%
  ggplot() +
  geom_line(
            aes(time, new_infections, colour = intervention_type,
              linetype = intervention_type
            ),
            linewidth = 1) +
  scale_y_continuous(
    labels = scales::comma
  ) +
  geom_vline(
    xintercept = c(
      vaccinate_01$time_begin,
      vaccinate_01$time_end
    ),
    linetype = 2
  ) +
  theme_bw() +
  labs(
    x = "Simulation time (days)",
    y = "Individuals"
  )
```












## Vaccination versus NPIs

compare multiple intervention scenarios, to lead onto health economics

```{r, echo = FALSE}
early_start <- 0
late_start <- 50
duration <- 100
time_end <- 200

# close schools early
close_schools_early <- intervention(
  name = "School closure",
  type = "contacts",
  time_begin = early_start,
  time_end = early_start + duration,
  reduction = matrix(c(0.5, 0.01, 0.01))
)


# vaccinate early
vacc_early <- vaccination(
  name = "vaccinate early", 
  nu = matrix(0.01, nrow = 3),
  time_begin = matrix(early_start, nrow = 3),
  time_end = matrix(early_start + duration, nrow = 3)
)

# vaccination late
vacc_late <- vaccination(
  name = "vaccinate all",
  time_begin = matrix(late_start, nrow(contact_matrix)),
  time_end = matrix(late_start + duration, nrow(contact_matrix)),
  nu = matrix(c(0.01, 0.01, 0.01))
)

# npis only (early)
output_npi_early <- model_default(
  population = uk_population,
  transmission_rate = transmission_rate,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  intervention = list(contacts = close_schools_early),
  time_end = time_end, increment = 1.0
)

# vaccination only (early)
output_vacc_early <- model_default(
  population = uk_population,
  transmission_rate = transmission_rate,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  vaccination = vacc_early,
  time_end = time_end, increment = 1.0
)

# vaccination only (late)
output_vacc_late <- model_default(
  population = uk_population,
  transmission_rate = transmission_rate,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  vaccination = vacc_late,
  time_end = time_end, increment = 1.0
)

# npis started early + vaccination late
output_npi_early_vacc_late <- model_default(
  population = uk_population,
  transmission_rate = transmission_rate,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  vaccination = vacc_late,
  intervention = list(contacts = close_schools_early),
  time_end = time_end, increment = 1.0
)

output_npi_early_vacc_late$intervention_type <- "npi early, vacc late"
output_npi_early$intervention_type <- "npi early"
output_vacc_early$intervention_type <- "vacc early"
output_vacc_late$intervention_type <- "vacc late"

output <- rbind(output_baseline, output_vacc_late,
                output_vacc_early, output_npi_early,
                output_npi_early_vacc_late)

```

```{r, echo = FALSE}
output %>%
  filter(compartment == "infectious") %>%
  ggplot() +
  aes(
    x = time,
    y = value,
    color = intervention_type,
    linetype = intervention_type
  ) +
  stat_summary(
    fun = "sum",
    geom = "line",
    linewidth = 1
  ) +
  scale_y_continuous(
    labels = scales::comma
  ) +
  geom_vline(
    xintercept = c(
      early_start,
      early_start + duration
    ),
    linetype = 2
  ) +
  geom_vline(
    xintercept = c(
      late_start,
      late_start + duration
    ),
    linetype = 3
  ) +
  theme_bw() +
  labs(
    x = "Simulation time (days)",
    y = "Individuals"
  )
```


::::::::::::::::::::::::::::::::::::: keypoints 

- Summarise the key points of the lesson using bullet points


::::::::::::::::::::::::::::::::::::::::::::::::
