---
title: 'Modelling disease burden'
teaching: 10 # teaching time in minutes
exercises: 5 # exercise time in minutes
---

:::::::::::::::::::::::::::::::::::::: questions 

- How can we model disease burden?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Understand when mathematical models of transmission can be separated from models of burden
- Generate disease burden using a burden model

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: prereq

+ Complete tutorial on [Simulating transmission](../episodes/simulating-transmission.md)

:::::::::::::::::::::::::::::::::


## Introduction

In previous tutorials we have used mathematical models to generate trajectories of infections, but we may also be interested in measures of disease. That could be measures of health in the population such as mild versus severe infections, or measures important to contingency planning of services being overwhelmed such as hospitalisations. 

In the case of hospitalisations, mathematical models comprised of ODEs may include a compartment for individuals in hospital (see for example the [Vacamole model](../episodes/compare-interventions.md#vacamole-model)). For diseases like Ebola, hospitalised cases contribute to new infections and therefore it is necessary to keep track of hospitalised individuals so their contribution to infection can be modelled. When hospitalised cases contribute little to transmission we can separate out models of transmission from models of burden. 

In this tutorial we will translate new infections generated from a transmission model to hospitalisations over time. We will use the in `{epidemics}` package to simulate disease trajectories, access to social contact data with `{socialmixr}` and `{ggplot2}` for plotting. 

```{r, warning = FALSE, message = FALSE}
library(epiparameter)
library(epidemics)
library(socialmixr)
library(ggplot2)
```


:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: instructor

Inline instructor notes can help inform instructors of timing challenges
associated with the lessons. They appear in the "Instructor View".


::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


## A burden model



**transmission model** 

**burden model** may not be strictly defined as equations but is still a model by definition. 

We will first gernate new 

```{r, echo = FALSE, message = FALSE}
# load contact and population data from socialmixr::polymod
polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  polymod,
  countries = "United Kingdom",
  age.limits = c(0, 20, 40),
  symmetric = TRUE
)

# prepare contact matrix
contact_matrix <- t(contact_data$matrix)

# prepare the demography vector
demography_vector <- contact_data$demography$population
names(demography_vector) <- rownames(contact_matrix)

# initial conditions: one in every 1 million is infected
initial_i <- 1e-6
initial_conditions_inf <- c(
  S = 1 - initial_i, E = 0, I = initial_i, R = 0, V = 0
)

initial_conditions_free <- c(
  S = 1, E = 0, I = 0, R = 0, V = 0
)

# build for all age groups
initial_conditions <- rbind(
  initial_conditions_inf,
  initial_conditions_free,
  initial_conditions_free
)
rownames(initial_conditions) <- rownames(contact_matrix)

# prepare the population to model as affected by the epidemic
uk_population <- epidemics::population(
  name = "UK",
  contact_matrix = contact_matrix,
  demography_vector = demography_vector,
  initial_conditions = initial_conditions
)

# time periods
preinfectious_period <- 3.0
infectious_period <- 7.0
basic_reproduction <- 1.46

# rates
infectiousness_rate <- 1.0 / preinfectious_period
recovery_rate <- 1.0 / infectious_period
transmission_rate <- basic_reproduction / infectious_period

# run an epidemic model using `epidemic()`
output_plot <- epidemics::model_default(
  population = uk_population,
  transmission_rate = transmission_rate,
  infectiousness_rate = infectiousness_rate,
  recovery_rate = recovery_rate,
  time_end = 600, increment = 1.0
)

new_cases <- new_infections(output_plot,
                            by_group = FALSE)
```

To convert the new infections to hospitalisations we need to parameter distributions to describe the following processes :

+ the time from onset of infection to admission to hospital,

+ the time from admission to discharge from hospital. 

We will use the function `epiparameter()` from `{epiparameter}` package to define and store parameter distributions for these processes.

```{r, message = FALSE}
# define delay parameters
onset_to_admission <- epiparameter(
  disease = "COVID-19",
  epi_name = "onset to admission",
  prob_distribution = create_prob_distribution(
    prob_distribution = "gamma",
    prob_distribution_params = c(shape = 5, scale = 4),
    discretise = TRUE
  )
)
```

To visualise this distribution we can create a density plot :

```{r}
x_range <- seq(0, 60, by = 0.1)
density_df <- data.frame(days = x_range,
                         density_admission = density(onset_to_admission,
                                                     x_range))

ggplot(data = density_df, aes(x = days, y = density_admission))  +
  geom_line() +
  theme_bw() +
  labs(
    x = "onset to admission (days)",
    y = "pdf"
  )

```


::::::::::::::::::::::::::::::::::::: challenge 

## Define distribution for admission to discharge

Using the function `epiparameter()` define the distribution for admission to discharge as a Gamma distribution with shape = 10 and scale = 2 and plot the density of this distribution. 

:::::::::::::::::::::::: solution 
 
```{r, message = FALSE}
admission_to_discharge <- epiparameter(
  disease = "COVID-19",
  epi_name = "admission to discharge",
  prob_distribution = create_prob_distribution(
    prob_distribution = "gamma",
    prob_distribution_params = c(shape = 10, scale = 2),
    discretise = TRUE
  )
)

x_range <- seq(0, 60, by = 0.1)
density_df <- data.frame(days = x_range,
                         density_discharge = density(admission_to_discharge,
                                                     x_range))


ggplot(data = density_df, aes(x = days, y = density_discharge)) +
  geom_line() +
  theme_bw() +
  labs(
    x = "admission to discharge (days)",
    y = "pdf"
  )

```

:::::::::::::::::::::::::::::::::
::::::::::::::::::::::::::::::::::::::::::::::::





```{r, message = FALSE}
ihr <- 0.1 # infection-hospitalisation ratio

# Calculate expected numbers with convolution:
hosp <- new_cases$new_infections * ihr

# define tail of the delay distribution
tail_value_admission <- quantile(onset_to_admission, 0.999)
tail_value_discharge <- quantile(admission_to_discharge, 0.999)

hospitalizations <- convolve(hosp, rev(density(onset_to_admission, 0:tail_value_admission)), type = "open")[1:length(hosp)]
discharges <- convolve(hospitalizations, rev(density(admission_to_discharge, 0:tail_value_discharge)), type = "open")[1:length(hospitalizations)]
in_hospital <- cumsum(hospitalizations) - cumsum(discharges)

# Plot results
plot(new_cases, type = "l")
lines(as.numeric(hospitalizations), col = "red")
lines(as.numeric(in_hospital), col = "blue")
```



## Summary

Summary text



::::::::::::::::::::::::::::::::::::: keypoints 

- Summarise the key points of the lesson using bullet points


::::::::::::::::::::::::::::::::::::::::::::::::
